name: Release Docker Image

on:
  workflow_dispatch:
  schedule:
    - cron: '0 9 * * 5'
  push:
    branches:
      - main

jobs:
  integration-test:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - uses: ./.github/actions/integration-test

  release:
    needs: [integration-test]
    name: Build and push image
    runs-on: ubuntu-latest
    strategy:
      matrix:
        fail-fast: false
        include:
          - platform: amd64
            base_image_tag: 2.15-alpine-3.18
          - platform: arm64
            ansible_image_tag: alpine
    permissions:
      contents: read
      packages: write
      # This is used to complete the identity challenge with sigstore/fulcio when running outside of PRs.
      id-token: write
    outputs:
      digests: ${{ steps.build.outputs.digests }}
      tags: ${{ steps.build.outputs.tags }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - uses: ./.github/actions/build-and-push
        id: build
        with:
          platform: ${{ matrix.platform }}
          ansible_image_tag: ${{ matrix.ansible_image_tag }}

  post-run:
    needs: [ release ]
    name: Post-run
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - uses: ./.github/actions/post-run
        with:
          digests: ${{ needs.release.outputs.digests }}
          tags: ${{ needs.release.outputs.tags }}
