---
- name: Start Docker Compose
  hosts: 127.0.0.1
  connection: local
  gather_facts: false

  vars:
    ghostfolio_dir: /mnt/user/appdata/ghostfolio

  tasks:
    - name: Check .env file existence
      stat:
        path: templates/.env
      register: file_info

    - name: Fail if .env file does not exist
      fail:
        msg: ".env File does not exist. Make sure to create one based on the example .env file."
      when: not file_info.stat.exists

    - name: Create directory ghostfolio_dir
      file:
        path: "{{ ghostfolio_dir }}"
        state: directory
        owner: 99
        group: 100
        mode: 0775
        recurse: yes

    - name: Copy .env file
      copy:
        src: templates/.env
        dest: "{{ ghostfolio_dir }}/.env"

    - name: Copy Docker Compose file
      template:
        src: templates/docker-compose.yml.j2
        dest: "{{ ghostfolio_dir }}/docker-compose.yml"

    - name: Stop existing docker compose containers
      command: docker-compose down --remove-orphans
      args:
        chdir: "{{ ghostfolio_dir }}"

    - name: Start Docker Compose
      command: docker-compose up --wait
      args:
        chdir: "{{ ghostfolio_dir }}"